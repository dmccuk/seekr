<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seekr.run â€” Lobby</title>
  <link rel="icon" type="image/x-icon" href="assets/seekr-favicon.ico" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0e1220; --muted:#55627a; --bg:#f6f8fc; --card:#ffffff;
      --brand:#1e4cff; --accent:#35c18f; --line:#e7ecf3;
      --good:#1f7a48; --bad:#b00020; --focus:#1e4cff33;
    }
    *{ box-sizing:border-box }
    html, body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .shell{ max-width:980px; margin:0 auto; padding:20px 16px 40px }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px }
    .brand{ font-weight:900; font-size:28px; letter-spacing:.6px; color:var(--ink) }
    .tag{ display:inline-block; font-size:13px; font-weight:600; color:var(--muted); padding:6px 10px; border-radius:999px; background:linear-gradient(180deg,#fff,#f7f9ff); border:1px solid var(--line) }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(20,32,70,.06); }
    .grid{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width:860px){ .grid{ grid-template-columns: 1fr 1fr; } }

    .sectionTitle{ margin:0 0 8px 0; font-weight:800; font-size:16px }
    .muted{ color:var(--muted) }
    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 14px; font-weight:800; color:#fff; cursor:pointer; box-shadow:0 4px 12px rgba(79,172,254,.35); background:linear-gradient(135deg,#4facfe,#00f2fe); }
    .btn.secondary{ background:linear-gradient(135deg,#00f2fe,#4facfe); }
    .btn.ghost{ background:#eef2fa; color:#364d9b; box-shadow:none; border:1px solid var(--line) }
    .btn.danger{ background:linear-gradient(135deg,#ff6a6a,#ff3b3b) }
    .btn.sm{ padding:6px 10px; font-size:12px; border-radius:10px }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }

    .pill{ display:inline-block; background:#eef2fa; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:12px; color:#55627a; }
    .list{ display:flex; flex-direction:column; gap:8px; margin-top:8px }
    .member{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff;
    }
    .name{ font-weight:700; display:flex; align-items:center; gap:6px; }
    .hostBadge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:11px; font-weight:700;
      background:#fff7e6; color:#b86f00; border:1px solid #ffe1a6;
    }
    .subtle{ font-size:12px; color:var(--muted) }
    .role{
      display:inline-flex; gap:6px; background:#f7faff; border:1px solid var(--line); border-radius:999px; padding:4px;
    }
    .seg{
      border:0; border-radius:999px; padding:6px 10px; font-weight:700; cursor:pointer; background:transparent; color:#55627a;
    }
    .seg.active{ background:#1e4cff; color:#fff; }
    .seg[disabled]{ opacity:.45; cursor:not-allowed }

    .info{ font-size:12px; color:var(--muted); margin-top:8px }
    .toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#0e1220; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.2); display:none; z-index:99999; font-size:14px; }
    :focus-visible{ outline:3px solid var(--focus); outline-offset:2px; border-radius:8px }

    .dangerNote{ font-size:12px; color:#b00020 }
    .okNote{ font-size:12px; color:#1f7a48 }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Consent overlay */
    .overlay{
      position:fixed; inset:0; background:rgba(14,18,32,.6);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .overlay .sheet{
      background:#fff; border:1px solid var(--line); border-radius:16px; padding:18px; max-width:520px; width:min(92vw,520px);
      box-shadow:0 20px 50px rgba(0,0,0,.25);
    }
    .overlay h3{ margin:0 0 8px 0; font-size:18px; font-weight:800 }
    .overlay p{ margin:0 0 10px 0; color:var(--muted) }
    .overlay .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <div class="brand">Seekr.run</div>
        <div class="tag" id="gameTag">Lobby â€¢ Loadingâ€¦</div>
      </div>
      <div class="row" style="gap:8px;">
        <button id="leaveBtn" class="btn ghost" type="button" title="Leave this game">Leave game</button>
        <a href="index.html" class="btn secondary">Home</a>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Invite & Settings -->
      <section class="card">
        <h3 class="sectionTitle">Invite</h3>
        <div class="row">
          <div>
            <div id="inviteCode" class="pill mono">CODE</div>
            <div class="info">Share this code with friends. Everyone joins this lobby.</div>
          </div>
          <div class="row" style="gap:8px">
            <button id="copyCode" class="btn ghost" type="button">Copy code</button>
            <button id="copyLink" class="btn ghost" type="button">Copy link</button>
          </div>
        </div>

        <h3 class="sectionTitle" style="margin-top:16px;">Round settings</h3>
        <div class="info" id="settingsInfo">Host sets these on the setup page. Lobby reads them from the game.</div>
        <ul class="info" style="margin:6px 0 0 16px;">
          <li>Duration: <span id="infoMinutes">â€”</span> min</li>
          <li>Fugitive ping every: <span id="infoPingMinutes">â€”</span> min</li>
          <li>Tag distance: <span id="infoTagM">â€”</span> m</li>
          <li>Uncertainty: <span id="infoUncM">â€”</span> m</li>
          <li>Reveal when: <span id="infoRevealRemain">â€”</span> min left</li>
        </ul>

        <div id="hostControls" style="margin-top:16px; display:none;">
          <div class="info" id="hostLine">You are the host.</div>
          <div class="row" style="margin-top:8px; gap:8px;">
            <button id="startBtn" class="btn" type="button" disabled>Start game</button>
            <button id="openAsHost" class="btn secondary" type="button">Join map</button>
            <button id="resetBtn" class="btn danger" type="button" style="display:none;">Reset to lobby</button>
          </div>
          <div id="startMsg" class="info"></div>
        </div>
      </section>

      <!-- Right: Players -->
      <section class="card">
        <h3 class="sectionTitle">Players</h3>
        <div class="row" style="align-items:flex-end;">
          <div>
            <div class="info">Pick a codename and toggle your role. Only one fugitive can be active.</div>
            <div id="fugitiveSlot" class="subtle" style="margin-top:4px;">Fugitive: â€”</div>
          </div>
          <div class="pill" id="countPill">0 players</div>
        </div>

        <div id="memberList" class="list" aria-live="polite"></div>

        <div class="row" style="margin-top:12px;">
          <button id="openGameplay" class="btn secondary" type="button">Join map</button>
        </div>

        <div id="liveNote" class="dangerNote" style="display:none;margin-top:8px;">
          This round is live; roles are locked. You can still open the map.
        </div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Consent overlay -->
  <div id="consent" class="overlay" role="dialog" aria-modal="true" aria-labelledby="consentTitle" aria-hidden="true" style="display:none;">
    <div class="sheet">
      <h3 id="consentTitle">Before you join</h3>
      <p>To play, you must be <strong>16+</strong> and agree to the Terms & Privacy.</p>
      <label style="display:flex; gap:.6rem; align-items:flex-start; margin-top:6px;">
        <input id="consentBox" type="checkbox" />
        <span>
          I am <strong>16+</strong> and I agree to the
          <a href="terms.html" target="_blank" rel="noopener">Terms</a> and
          <a href="privacy.html" target="_blank" rel="noopener">Privacy Notice</a>. I allow precise location during the round. GPS & chat are deleted within <strong>48h</strong>.
        </span>
      </label>
      <div class="actions">
        <button id="consentLeave" class="btn ghost" type="button">Leave</button>
        <button id="consentAgree" class="btn" type="button" disabled>Agree & join</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot,
      collection, query, orderBy, serverTimestamp, runTransaction,
      deleteField, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHJuv3vZH1dMzLkihl6hNQdlHOQNg728M",
      authDomain: "seekr-426ff.firebaseapp.com",
      projectId: "seekr-426ff",
      storageBucket: "seekr-426ff.firebasestorage.app",
      messagingSenderId: "703306109182",
      appId: "1:703306109182:web:afb04af22e974170e555af"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const toastEl = document.getElementById('toast');
    const gameTag = document.getElementById('gameTag');
    const inviteCodeEl = document.getElementById('inviteCode');
    const copyCodeBtn = document.getElementById('copyCode');
    const copyLinkBtn = document.getElementById('copyLink');
    const infoMinutes = document.getElementById('infoMinutes');
    const infoPingMinutes = document.getElementById('infoPingMinutes');
    const infoTagM = document.getElementById('infoTagM');
    const infoUncM = document.getElementById('infoUncM');
    const infoRevealRemain = document.getElementById('infoRevealRemain');
    const hostControls = document.getElementById('hostControls');
    const hostLine = document.getElementById('hostLine');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const startMsg = document.getElementById('startMsg');
    const openAsHostBtn = document.getElementById('openAsHost');
    const memberList = document.getElementById('memberList');
    const countPill = document.getElementById('countPill');
    const openGameplayBtn = document.getElementById('openGameplay');
    const liveNote = document.getElementById('liveNote');
    const fugitiveSlotEl = document.getElementById('fugitiveSlot');
    const leaveBtn = document.getElementById('leaveBtn');

    // Consent overlay refs
    const consentEl = document.getElementById('consent');
    const consentBox = document.getElementById('consentBox');
    const consentAgree = document.getElementById('consentAgree');
    const consentLeave = document.getElementById('consentLeave');

    // State
    const url = new URL(location.href);
    const code = url.searchParams.get("code")?.toUpperCase() || "";
    if (!code) {
      alert("Missing game code. Open with ?code=ABC123");
      location.href = "index.html";
    }
    inviteCodeEl.textContent = code;
    gameTag.textContent = `Lobby â€¢ ${code}`;

    let me = { uid:null, isHost:false, displayName:null };
    let game = null;
    let roster = []; // [{uid, role, displayName}...]
    let hasConsent = false;

    const isLobby = () => (game && game.status === "lobby");

    function toast(t){
      toastEl.textContent = t;
      toastEl.style.display = 'block';
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(() => toastEl.style.display = 'none', 2000);
    }

    function setLobbyControlsEnabled(on){
      // gate critical actions behind consent
      startBtn.disabled = !on || startBtn.disabled; // keep existing gating if already disabled
      openGameplayBtn.disabled = !on;
      openAsHostBtn.disabled = !on;
    }

    // Simple codename generator
    const ADJ = ["Neon","Swift","Silent","Crimson","Lucky","Shadow","Wild","Nimble","Iron","Delta","Atomic","Echo","Fuzzy","Turbo","Mellow","Golden","Cosmic","Feral","Frost","Quantum"];
    const NOUN = ["Falcon","Fox","Badger","Panther","Viper","Raven","Otter","Wolf","Jaguar","Hawk","Lynx","Cobra","Moose","Tiger","Panda","Eagle","Bison","Drake","Mantis","Orca"];
    function makeCodename(){
      const a = ADJ[Math.floor(Math.random()*ADJ.length)];
      const n = NOUN[Math.floor(Math.random()*NOUN.length)];
      const num = Math.floor(Math.random()*900)+100; // 100-999
      return `${a} ${n} ${num}`;
    }
    function sanitizeName(s){
      return String(s||"").replace(/\s+/g, " ").trim().slice(0, 26);
    }

    async function ensureGameAndMembership(uid){
      const gameRef   = doc(db, "games", code);
      const memberRef = doc(db, "games", code, "members", uid);

      // Ensure game exists; first writer becomes host
      try {
        const gSnap = await getDoc(gameRef);
        if (!gSnap.exists()) {
          await setDoc(gameRef, { code, status:"lobby", createdAt: serverTimestamp() }, { merge:true });
        }
        const gSnap2 = await getDoc(gameRef);
        const gData = gSnap2.data() || {};
        if (!gData.hostUid) {
          try { await setDoc(gameRef, { hostUid: uid }, { merge:true }); } catch {}
        }
      } catch(e){
        console.warn("Game ensure failed", e);
      }

      // Create/merge my membership (default role: hunter)
      try{
        await setDoc(memberRef, {
          role: "hunter",
          createdAt: serverTimestamp()
        }, { merge:true });
      } catch(e){
        console.warn("Member bootstrap failed", e);
      }

      // Ensure I have a codename
      try{
        await runTransaction(db, async (tx) => {
          const m = await tx.get(memberRef);
          if (!m.exists()) return;
          const d = m.data() || {};
          if (!d.displayName) {
            tx.set(memberRef, { displayName: makeCodename() }, { merge:true });
          }
        });
      }catch(e){
        console.warn("Codename ensure failed", e);
      }
    }

    // Role switching with a transactional fugitive slot (only in Lobby)
    async function claimFugitive(uid){
      if (!isLobby()){ toast("Roles are locked while live"); return false; }
      if (!hasConsent){ toast("Agree to Terms to change roles"); return false; }
      const gameRef = doc(db, "games", code);
      const myRef = doc(db, "games", code, "members", uid);
      try{
        const ok = await runTransaction(db, async (tx) => {
          const gDoc = await tx.get(gameRef);
          if (!gDoc.exists()) return false;
          const g = gDoc.data() || {};
          if (g.status !== "lobby") return false;
          const current = g.fugitiveUid || null;
          if (current && current !== uid) return false; // already taken
          tx.set(gameRef, { fugitiveUid: uid }, { merge:true });
          tx.set(myRef, { role: "fugitive" }, { merge:true });
          return true;
        });
        if (!ok){ toast("Fugitive slot is already taken"); return false; }
        toast("You are the fugitive");
        return true;
      }catch(e){
        console.warn("claimFugitive failed", e);
        toast("Could not claim fugitive");
        return false;
      }
    }
    async function releaseFugitive(uid){
      if (!isLobby()){ toast("Roles are locked while live"); return; }
      const gameRef = doc(db, "games", code);
      const myRef = doc(db, "games", code, "members", uid);
      try{
        await runTransaction(db, async (tx) => {
          const gDoc = await tx.get(gameRef);
          if (!gDoc.exists()) return;
          const g = gDoc.data() || {};
          if (g.status !== "lobby") return;
          const current = g.fugitiveUid || null;
          if (current === uid){
            tx.set(gameRef, { fugitiveUid: null }, { merge:true });
          }
          tx.set(myRef, { role: "hunter" }, { merge:true });
        });
        toast("You are a hunter");
      }catch(e){
        console.warn("releaseFugitive failed", e);
        toast("Could not switch role");
      }
    }

    // Rename myself
    async function renameMe(){
      const want = sanitizeName(prompt("Pick a codename (2â€“26 chars):", me.displayName || makeCodename()));
      if (!want || want.length < 2){ return; }
      try{
        await setDoc(doc(db, "games", code, "members", me.uid), { displayName: want }, { merge:true });
        toast("Name updated");
      }catch(e){
        console.warn(e); toast("Could not update name");
      }
    }

    // Consent helpers
    async function ensureConsentOrPrompt(db, code, uid){
      const memberRef = doc(db, "games", code, "members", uid);
      const snap = await getDoc(memberRef);
      const m = snap.exists() ? (snap.data() || {}) : {};
      const needParam = url.searchParams.get('needconsent') === '1';
      const ok = m.ageAffirmed === true && !!m.locationConsentAt;
      hasConsent = !!ok;
      if (ok && !needParam){
        setLobbyControlsEnabled(true);
        return true;
      }
      // block controls & show overlay
      setLobbyControlsEnabled(false);
      consentEl.style.display = 'flex';
      consentEl.setAttribute('aria-hidden', 'false');
      return false;
    }

    consentBox.addEventListener('change', () => {
      consentAgree.disabled = !consentBox.checked;
    });
    consentLeave.addEventListener('click', () => {
      location.href = "index.html";
    });
    consentAgree.addEventListener('click', async () => {
      const uid = auth.currentUser?.uid;
      if (!uid) return;
      await setDoc(doc(db, "games", code, "members", uid), {
        ageAffirmed: true,
        locationConsentAt: serverTimestamp(),
        policyVer: "2025-08-16"
      }, { merge:true });
      hasConsent = true;
      consentEl.style.display = 'none';
      consentEl.setAttribute('aria-hidden', 'true');
      toast("Thanks â€” youâ€™re good to go.");
      setLobbyControlsEnabled(true);
    });

    // Leave game
    async function leaveGame(){
      if (!confirm("Leave this game? Your codename and lobby entry will be removed.")) return;
      const uid = auth.currentUser?.uid;
      if (!uid) return;
      const gameRef = doc(db, "games", code);
      const myRef = doc(db, "games", code, "members", uid);
      try{
        await runTransaction(db, async (tx) => {
          const gDoc = await tx.get(gameRef);
          if (gDoc.exists()){
            const g = gDoc.data() || {};
            const patch = {};
            if (g.fugitiveUid === uid) patch.fugitiveUid = null;
            if (g.hostUid === uid) patch.hostUid = deleteField();
            if (Object.keys(patch).length) tx.set(gameRef, patch, { merge:true });
          }
        });
        await deleteDoc(myRef);
        location.href = "index.html";
      }catch(e){
        console.warn("Leave failed", e);
        toast("Could not leave the game");
      }
    }

    leaveBtn.addEventListener('click', leaveGame);

    // Wiring
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, async user => {
      if (!user) return;
      me.uid = user.uid;

      await ensureGameAndMembership(me.uid);
      await ensureConsentOrPrompt(db, code, me.uid);

      const gameRef = doc(db, "games", code);
      const myRef = doc(db, "games", code, "members", me.uid);

      // Game listener (status, rules, host, fugitive slot)
      onSnapshot(gameRef, s => {
        if (!s.exists()) return;
        game = s.data();
        const rules = game.rules || {};
        const lobbyCfg = game.lobbyConfig || {};

        me.isHost = (game.hostUid === me.uid);
        hostControls.style.display = me.isHost ? 'block' : 'none';

        // Host display in header (name if we know it)
        const hostUid = game.hostUid || null;
        let hostName = hostUid ? (roster.find(r => r.uid === hostUid)?.displayName || hostUid.slice(0,6)+"â€¦") : "â€”";
        const hostLabel = me.isHost ? "You" : hostName;

        gameTag.textContent = `${game.status === "live" ? "Live" : "Lobby"} â€¢ ${code} â€¢ Host: ${hostLabel}`;
        liveNote.style.display = game.status === "live" ? 'block' : 'none';
        resetBtn.style.display = (me.isHost && game.status !== "lobby") ? "inline-block" : "none";

        infoMinutes.textContent = Number(rules.game_minutes ?? 30);
        infoPingMinutes.textContent = Number(rules.ping_minutes ?? 5);
        infoTagM.textContent = Number(rules.tag_meters ?? 5);
        infoUncM.textContent = Number(lobbyCfg.uncertaintyM ?? rules.uncertainty_m ?? 50);
        infoRevealRemain.textContent = Number(rules.reveal_minutes_remaining ?? 15);

        // Show fugitive slot owner (by codename if we have it in roster)
        const fugUid = game.fugitiveUid || null;
        const name = fugUid ? (roster.find(r => r.uid === fugUid)?.displayName || fugUid.slice(0,6)+"â€¦") : "â€”";
        fugitiveSlotEl.textContent = `Fugitive: ${name}`;

        // Host start gating: 1 fugitive + >=1 hunter
        const total = roster.length;
        const fugitiveCount = fugUid ? 1 : 0;
        const hunters = Math.max(0, total - fugitiveCount);
        if (me.isHost){
          const ok = (fugitiveCount === 1) && (hunters >= 1) && hasConsent;
          startBtn.disabled = !ok;
          startMsg.textContent = ok
            ? (game.status === "lobby" ? 'Ready to start.' : 'Ready â€” pressing Start will (re)arm timers and keep the round live.')
            : 'Need exactly 1 fugitive and at least 1 hunter (and you must agree to Terms).';
          startMsg.style.color = ok ? 'var(--good)' : 'var(--bad)';
          hostLine.textContent = me.isHost ? 'You are the host.' : '';
        }

        // Also gate â€œJoin mapâ€ if consent missing
        setLobbyControlsEnabled(!!hasConsent);
      });

      // Roster listener
      const qMembers = query(collection(db, "games", code, "members"), orderBy("createdAt", "asc"));
      onSnapshot(qMembers, snap => {
        roster = snap.docs.map(d => ({ uid:d.id, ...(d.data()||{}) }));
        const fugUid = (game && game.fugitiveUid) || null;
        const roundLocked = game && game.status !== "lobby";

        // Build UI
        const items = [];
        roster.forEach(m => {
          const isMe = (m.uid === me.uid);
          const name = m.displayName || (m.uid.slice(0,6)+"â€¦");
          const isFugitive = (fugUid && fugUid === m.uid) || m.role === "fugitive";
          const isHostRow = game && game.hostUid === m.uid;

          const row = document.createElement('div');
          row.className = 'member';

          const left = document.createElement('div');
          left.className = 'left';
          left.innerHTML = `
            <div class="name">
              ${name}
              ${isHostRow ? '<span class="hostBadge" title="Host">ðŸ‘‘ Host</span>' : ''}
              ${isMe ? '<button class="btn sm ghost" id="rn_'+m.uid+'" type="button" style="margin-left:6px;">Rename</button>' : ''}
            </div>
            <div class="subtle mono">#${m.uid.slice(0,6)}</div>
          `;
          row.appendChild(left);

          const right = document.createElement('div');
          if (isMe){
            // my role controls (locked when not in Lobby or no consent)
            const wrap = document.createElement('div');
            wrap.className = 'role';

            const btnF = document.createElement('button');
            btnF.type = 'button';
            btnF.className = 'seg' + (isFugitive ? ' active' : '');
            btnF.textContent = 'Fugitive';
            btnF.disabled = roundLocked || !hasConsent || (!isFugitive && !!fugUid);
            if (roundLocked) btnF.title = "Roles are locked while the round is live";
            if (!hasConsent) btnF.title = "Agree to Terms to change roles";
            btnF.addEventListener('click', async () => {
              if (btnF.disabled) return;
              await claimFugitive(me.uid);
            });

            const btnH = document.createElement('button');
            btnH.type = 'button';
            btnH.className = 'seg' + (!isFugitive ? ' active' : '');
            btnH.textContent = 'Hunter';
            btnH.disabled = roundLocked || !hasConsent;
            if (roundLocked) btnH.title = "Roles are locked while the round is live";
            if (!hasConsent) btnH.title = "Agree to Terms to change roles";
            btnH.addEventListener('click', async () => {
              if (btnH.disabled) return;
              if (!isFugitive) return;
              await releaseFugitive(me.uid);
            });

            wrap.appendChild(btnF);
            wrap.appendChild(btnH);
            right.appendChild(wrap);
          } else {
            // show role pill resolved by the slot
            const tag = document.createElement('div');
            tag.className = 'pill';
            tag.textContent = isFugitive ? 'Fugitive' : 'Hunter';
            right.appendChild(tag);
          }
          row.appendChild(right);
          items.push(row);

          // wire rename button after insert
          setTimeout(() => {
            const rn = document.getElementById('rn_'+m.uid);
            if (rn) rn.addEventListener('click', renameMe);
          }, 0);
        });

        memberList.replaceChildren(...items);

        // counts
        const total = roster.length;
        const fugitiveCount = (game && game.fugitiveUid) ? 1 : 0;
        const hunterCount = Math.max(0, total - fugitiveCount);
        countPill.textContent = `${total} player${total===1?'':'s'} â€” ${fugitiveCount} fugitive â€¢ ${hunterCount} hunter${hunterCount===1?'':'s'}`;

        // update fugitiveSlot label (now we may know codename)
        if (game){
          const fugUid2 = game.fugitiveUid || null;
          const name2 = fugUid2 ? (roster.find(r => r.uid === fugUid2)?.displayName || fugUid2.slice(0,6)+"â€¦") : "â€”";
          fugitiveSlotEl.textContent = `Fugitive: ${name2}`;
        }

        // refresh Start gating
        if (me.isHost){
          const ok = (fugitiveCount === 1) && (hunterCount >= 1) && hasConsent;
          startBtn.disabled = !ok;
          startMsg.textContent = ok
            ? (game && game.status === "lobby" ? 'Ready to start.' : 'Ready â€” pressing Start will (re)arm timers and keep the round live.')
            : 'Need exactly 1 fugitive and at least 1 hunter (and you must agree to Terms).';
          startMsg.style.color = ok ? 'var(--good)' : 'var(--bad)';
        }

        // update header host name now that we have roster
        if (game){
          const hostUid = game.hostUid || null;
          const hostName = hostUid ? (roster.find(r => r.uid === hostUid)?.displayName || hostUid.slice(0,6)+"â€¦") : "â€”";
          const hostLabel = (hostUid === me.uid) ? "You" : hostName;
          gameTag.textContent = `${game.status === "live" ? "Live" : "Lobby"} â€¢ ${code} â€¢ Host: ${hostLabel}`;
        }
      });

      // Keep my displayName in local state
      onSnapshot(myRef, s => {
        const d = s.exists() ? s.data() : {};
        me.displayName = d.displayName || null;
      });

      // Buttons
      copyCodeBtn.addEventListener('click', async () => {
        try{ await navigator.clipboard.writeText(code); toast('Code copied'); } catch {}
      });
      copyLinkBtn.addEventListener('click', async () => {
        const u = `${location.origin}/lobby.html?code=${encodeURIComponent(code)}`;
        try{ await navigator.clipboard.writeText(u); toast('Link copied'); } catch {}
      });
      openGameplayBtn.addEventListener('click', () => {
        if (!hasConsent){ toast("Agree to Terms first"); return; }
        location.href = `gameplay.html?code=${encodeURIComponent(code)}`;
      });
      openAsHostBtn.addEventListener('click', () => {
        if (!hasConsent){ toast("Agree to Terms first"); return; }
        location.href = `gameplay.html?code=${encodeURIComponent(code)}`;
      });

      // Start round â€” (re)arm even if status currently shows live
      startBtn.addEventListener('click', async () => {
        if (!me.isHost) return;

        const fugUid = (game && game.fugitiveUid) || null;
        if (!fugUid){ toast("Assign a fugitive first"); return; }
        const hunters = Math.max(0, roster.length - 1);
        if (hunters < 1){ toast("Need at least one hunter"); return; }

        const now = Date.now();
        const rules = (game && game.rules) || {};
        const mins = Number(rules.game_minutes ?? 30);
        const durMs = Math.max(1, mins) * 60 * 1000;

        const hasStartsAt = !!(game && game.startsAt);
        const hasEndsAt   = !!(game && game.endsAt);
        const startsAt = hasStartsAt ? null : new Date(now + 5000); // 5s arm delay if not set
        const endsAt   = hasEndsAt   ? null : new Date((hasStartsAt ? (new Date(game.startsAt).getTime()) : (now + 5000)) + durMs);

        let revealAt = null;
        if (!game || !game.revealAt) {
          const remainMin = Number(rules.reveal_minutes_remaining || 0);
          if (remainMin > 0 && (endsAt || game?.endsAt)) {
            const endMs = endsAt ? endsAt.getTime() : new Date(game.endsAt).getTime();
            revealAt = new Date(Math.max(endMs - remainMin*60000, (startsAt ? startsAt.getTime() : Date.now()) + 1000));
          }
        }

        try{
          await setDoc(doc(db, "games", code), {
            status: "live",
            ...(startsAt ? { startsAt } : {}),
            ...(endsAt   ? { endsAt }   : {}),
            ...(revealAt ? { revealAt } : {}),
          }, { merge:true });
          toast("Round armed â€” switching to Gameplay");
          startMsg.textContent = "Startingâ€¦ open the map";
          startMsg.style.color = 'var(--good)';
        }catch(e){
          console.error(e);
          toast("Failed to start round");
        }
      });

      // Reset to Lobby (host only)
      resetBtn.addEventListener('click', async () => {
        if (!me.isHost) return;
        if (!confirm("Reset this round to Lobby and unlock roles?")) return;
        try{
          await setDoc(doc(db, "games", code), {
            status: "lobby",
            fugitiveUid: null,
            startsAt: deleteField(),
            endsAt: deleteField(),
            revealAt: deleteField()
          }, { merge:true });
          toast("Reset to lobby");
        }catch(e){
          console.error(e);
          toast("Failed to reset");
        }
      });
    });
  </script>
</body>
</html>
