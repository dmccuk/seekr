<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seekr.run - Gameplay demo</title>
  <meta name="description" content="Seekr.run gameplay demo: set a zone, configure rules (including reveal timing), generate a code, then go to the lobby." />
  <link rel="icon" type="image/x-icon" href="assets/seekr-favicon.ico" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --ink:#0e1220; --muted:#55627a; --bg:#f6f8fc; --card:#ffffff;
      --brand:#1e4cff; --accent:#35c18f; --line:#e7ecf3;
      --good:#1f7a48; --bad:#b00020; --focus:#1e4cff33;
    }
    *{ box-sizing:border-box }
    html, body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height:1.35; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .shell{ max-width:1100px; margin:0 auto; padding:24px 16px 56px }

    /* Header */
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px }
    .brand{
      font-weight:900; font-size:32px; letter-spacing:.6px; line-height:1.1; color:var(--ink);
      text-shadow:0 2px 10px rgba(30,76,255,.12), 0 1px 0 #fff;
    }
    .tag{
      display:inline-block; margin-top:6px; font-size:14px; font-weight:600; color:var(--muted);
      padding:6px 10px; border-radius:999px; background:linear-gradient(180deg,#fff,#f7f9ff); border:1px solid var(--line);
      box-shadow:0 6px 18px rgba(20,32,70,.06);
    }

    .btn{
      appearance:none; border:0; border-radius:12px; padding:12px 14px; font-weight:800; color:#fff;
      background:linear-gradient(135deg,#4facfe,#00f2fe); cursor:pointer; box-shadow:0 4px 12px rgba(79,172,254,.35);
      text-decoration:none; display:inline-block;
    }
    .btn.secondary{ background:linear-gradient(135deg,#8e9eab,#eef2f3); color:#0e1220; box-shadow:none }
    .btn.ghost{ background:#fff; color:#0e1220; border:1px solid var(--line); box-shadow:none }
    .btn:focus-visible{ outline:3px solid var(--focus); outline-offset:2px }

    /* How it works strip */
    .hiw{
      display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:8px 0 16px 0;
    }
    .hiw .chip{
      background:#fff; border:1px solid var(--line); border-radius:14px; padding:10px 12px;
      display:flex; align-items:center; gap:10px; box-shadow:0 8px 22px rgba(20,32,70,.06);
      font-weight:600;
    }
    .hiw .ico{ width:26px; height:26px; border-radius:8px; background:#eef2ff; display:grid; place-items:center; font-size:14px; color:var(--brand) }
    @media (max-width:720px){ .hiw{ grid-template-columns:1fr } }

    /* Cards and layout */
    .grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:18px }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr } }

    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(20,32,70,.06);
    }
    .card h2{ margin:4px 0 10px 0; font-size:18px; font-weight:800 }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .stack{ display:grid; gap:10px }
    .two{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    @media (max-width:520px){ .two{ grid-template-columns:1fr } }

    label{ font-size:13px; color:var(--muted) }
    input[type="number"], input[type="text"], select{
      border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-family:inherit; background:#fff; width:100%;
    }

    #map{ width:100%; height:min(64vh,520px); border-radius:12px; overflow:hidden }

    .pill{
      display:inline-block; background:#eef2fa; border:1px solid var(--line);
      border-radius:999px; padding:6px 10px; font-size:12px; color:#55627a;
    }

    /* Actions */
    .switch{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; font-size:13px; color:var(--ink) }
    .switch input{ display:none }
    .track{ width:46px; height:26px; background:#d7deea; border-radius:999px; position:relative; transition:background .2s }
    .dot{ position:absolute; top:3px; left:3px; width:20px; height:20px; border-radius:50%; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.2); transition:left .2s }
    .switch input:checked + .track{ background:#26a269 } .switch input:checked + .track .dot{ left:23px }
    .fineprint{ font-size:12px; color:var(--muted) }

    /* Code box and WhatsApp */
    .codeBox{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      background:#f7f9ff; border:1px dashed #c7d2ee; padding:10px 12px; border-radius:12px;
    }
    .code{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:800; letter-spacing:.12em }

    .whatsapp-btn{
      background:#25D366; color:#fff; border-radius:50%; width:46px; height:46px;
      display:flex; align-items:center; justify-content:center; border:none; cursor:pointer;
      box-shadow:0 4px 8px rgba(0,0,0,0.15);
    }
    .whatsapp-btn:hover{ background:#20b358 }
    .whatsapp-btn svg{ width:22px; height:22px; display:block; fill:currentColor }

    .footnote{ margin-top:8px; font-size:12px; color:var(--muted) }

    /* Onboarding overlay */
    .overlay{
      position:fixed; inset:0; background:rgba(14,18,32,.6);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .overlay .sheet{
      background:#fff; border:1px solid var(--line); border-radius:16px; padding:18px; max-width:520px; width:min(90vw,520px);
      box-shadow:0 20px 50px rgba(0,0,0,.25);
    }
    .overlay h3{ margin:0 0 8px 0; font-size:18px; font-weight:800 }
    .overlay p{ margin:0 0 10px 0; color:var(--muted) }
    .overlay .steps{ display:grid; gap:8px; margin:12px 0 }
    .overlay .steps div{ display:flex; gap:10px; align-items:center; background:#f8faff; border:1px solid var(--line); border-radius:12px; padding:10px }
    .overlay .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:#0e1220; color:#fff; padding:10px 14px; border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.2); display:none; z-index:99999; font-size:14px;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .btn{ transition:none }
    }

    /* Focus ring helper */
    :focus-visible{ outline:3px solid var(--focus); outline-offset:2px; border-radius:8px }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <div class="brand">Seekr.run</div>
        <div class="tag">Set up your round, then go to the lobby</div>
      </div>
      <a href="index.html" class="btn secondary">Back</a>
    </header>

    <!-- How it works strip -->
    <div class="hiw" aria-label="How it works">
      <div class="chip"><span class="ico">üìç</span>Set the zone</div>
      <div class="chip"><span class="ico">üïµÔ∏è</span>Lobby: pick roles</div>
      <div class="chip"><span class="ico">üèÅ</span>Host starts & extraction reveals late</div>
    </div>

    <div class="grid">
      <!-- Map and zone -->
      <section class="card">
        <h2>Pick your playing area</h2>
        <div id="map" role="img" aria-label="Select a game area on map"></div>

        <div class="two" style="margin-top:10px;">
          <div class="stack">
            <label for="radiusKm">Area radius, km</label>
            <input id="radiusKm" type="number" min="0.2" max="50" step="0.1" value="0.6" />
          </div>
          <div class="stack">
            <label class="muted">Center, drag the pin</label>
            <div class="pill" id="centerReadout">lat 0, lng 0</div>
          </div>
        </div>

        <div class="two" style="margin-top:10px;">
          <div class="stack">
            <label for="uncertaintyM">Last ping uncertainty, m</label>
            <input id="uncertaintyM" type="number" min="10" max="200" step="5" value="50" />
          </div>
          <div class="stack">
            <label class="muted">Extraction</label>
            <div class="pill">Auto-placed inside the zone on ‚ÄúGo to Lobby‚Äù</div>
          </div>
        </div>

        <div class="footnote">Your location is used only to center this demo map.</div>
      </section>

      <!-- Rules and code -->
      <section class="card">
        <h2>Rules</h2>

        <!-- Quick presets -->
        <div class="row" style="margin-bottom:8px;">
          <button class="btn ghost" id="presetHunt" type="button" title="Many seekers vs one fugitive">Preset, Fugitive Hunt</button>
          <button class="btn ghost" id="presetTeam" type="button" title="Team vs team">Preset, Team Battle</button>
          <button class="btn ghost" id="presetLarge" type="button" title="Large zone hunts">Preset, Large Zone</button>
        </div>

        <div class="two">
          <div class="stack">
            <label for="gameLen">Game length, minutes</label>
            <input id="gameLen" type="number" min="5" max="240" step="5" value="30" />
          </div>
          <div class="stack">
            <label for="tagDist">Tag distance, meters</label>
            <input id="tagDist" type="number" min="2" max="50" step="1" value="8" />
          </div>
        </div>

        <!-- Reveal timing control -->
        <div class="two" style="margin-top:10px;">
          <div class="stack">
            <label for="revealRemain">Reveal extraction when <strong>minutes remain</strong></label>
            <input id="revealRemain" type="number" min="1" max="239" step="1" value="15" />
          </div>
          <div class="stack">
            <label for="pingMins">Fugitive ping interval, minutes</label>
            <input id="pingMins" type="number" min="1" max="15" step="1" value="5" />
          </div>
        </div>

        <div class="stack" style="margin-top:10px;">
          <label><strong>Actions</strong> (optional strategy)</label>
          <label class="switch"><input id="puDelay" type="checkbox" checked><span class="track"><span class="dot"></span></span>Delay next reveal</label>
          <label class="switch"><input id="puDecoy" type="checkbox" checked><span class="track"><span class="dot"></span></span>Create a short decoy trail</label>
          <label class="switch"><input id="puReveal" type="checkbox"><span class="track"><span class="dot"></span></span>Instant reveal, seeker only</label>
          <div class="fineprint">Each action costs 25 Tokens to use.</div>
        </div>

        <div class="stack" style="margin-top:14px;">
          <div class="codeBox">
            <div class="muted">Game code</div>
            <div id="code" class="code">AAAAAA</div>
            <button id="btnCode" class="btn" type="button">Generate</button>
            <button id="btnCopyLobby" class="btn ghost" type="button">Copy lobby link</button>
            <button id="btnShareWA" class="whatsapp-btn" type="button" title="Share on WhatsApp" aria-label="Share on WhatsApp">
              <svg viewBox="0 0 32 32" aria-hidden="true"><path d="M19.11 17.39c-.3-.15-1.77-.87-2.05-.97-.28-.1-.49-.15-.7.15s-.8.97-.98 1.17c-.18.2-.36.22-.66.07-.3-.15-1.28-.47-2.44-1.5-.9-.8-1.52-1.78-1.7-2.08-.18-.3-.02-.46.13-.61.14-.14.3-.36.45-.54.15-.18.2-.3.3-.5.1-.2.05-.37-.02-.52-.07-.15-.7-1.69-.96-2.3-.25-.6-.51-.52-.7-.53l-.6-.01c-.2 0-.52.07-.79.37-.27.3-1.04 1.02-1.04 2.49s1.07 2.89 1.22 3.09c.15.2 2.1 3.2 5.08 4.49.71.31 1.27.5 1.7.64.71.23 1.36.2 1.87.12.57-.09 1.77-.72 2.03-1.42.25-.7.25-1.29.18-1.42-.07-.13-.27-.2-.57-.35zM16 3.1c-7.12 0-12.9 5.78-12.9 12.9 0 2.28.6 4.51 1.75 6.47L3 29l6.74-1.77a12.83 12.83 0 0 0 6.26 1.6c7.12 0 12.9-5.78 12.9-12.9S23.12 3.1 16 3.1zm0 23.36c-2.15 0-4.25-.58-6.08-1.68l-.44-.26-4.02 1.06 1.08-3.92-.28-.45a10.77 10.77 0 1 1 9.74 5.25z" fill="currentColor"/></svg>
            </button>
          </div>

          <!-- Single CTA -->
          <button id="btnGoLobby" class="btn" type="button">Go to Lobby</button>
          <div id="status" class="footnote" aria-live="polite"></div>

          <div class="footnote">The lobby handles role selection and starting the round. Questions? <a href="index.html#faq">Check the FAQ</a>.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Onboarding overlay -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="obTitle" aria-hidden="true">
    <div class="sheet">
      <h3 id="obTitle">Quick setup</h3>
      <p>Three steps and you are ready.</p>
      <div class="steps">
        <div>1, Drag the pin to set the center and adjust the radius.</div>
        <div>2, We‚Äôll auto-place a hidden extraction point inside the zone when you go to the lobby.</div>
        <div>3, Pick rules (including reveal timing), generate a code, then go to the lobby.</div>
      </div>
      <div class="actions">
        <button id="obSkip" class="btn ghost" type="button">Skip</button>
        <button id="obGo" class="btn" type="button">Got it</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- MAP + DEMO LOGIC (non-module) -->
  <script>
    // Map setup (no manual extraction UI)
    let map, centerMarker, areaCircle, uncertaintyCircle;

    const centerReadout    = document.getElementById('centerReadout');
    const radiusInput      = document.getElementById('radiusKm');
    const uncertaintyInput = document.getElementById('uncertaintyM');
    const statusEl         = document.getElementById('status');
    const toastEl          = document.getElementById('toast');

    function showToast(t){
      toastEl.textContent = t;
      toastEl.style.display = 'block';
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(() => { toastEl.style.display = 'none'; }, 2200);
    }

    function setCenterReadout(latlng){
      centerReadout.textContent = 'lat ' + latlng.lat.toFixed(5) + ', lng ' + latlng.lng.toFixed(5);
    }

    function drawUncertainty(latlng, meters){
      if(!uncertaintyCircle){
        uncertaintyCircle = L.circle(latlng, {
          radius: meters, color:'#f59f00', weight:2, fillColor:'#f59f00', fillOpacity:0.12, dashArray:'4,6'
        }).addTo(map);
      }else{
        uncertaintyCircle.setLatLng(latlng);
        uncertaintyCircle.setRadius(meters);
      }
    }

    function initMap(lat=51.505, lng=-0.09){
      map = L.map('map', { zoomControl:true, attributionControl:false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
      const start = L.latLng(lat, lng);
      map.setView(start, 15);

      centerMarker = L.marker(start, { draggable:true, title:'Drag to set center' }).addTo(map);
      areaCircle   = L.circle(start, { radius: Number(radiusInput.value) * 1000, color:'#1e4cff', fillColor:'#1e4cff', fillOpacity:0.12 }).addTo(map);
      setCenterReadout(start);
      drawUncertainty(start, Number(uncertaintyInput.value));

      centerMarker.on('drag', e => {
        const p = e.target.getLatLng();
        areaCircle.setLatLng(p);
        drawUncertainty(p, Number(uncertaintyInput.value));
        setCenterReadout(p);
      });

      // Expose to module
      window.seekrCenterMarker = centerMarker;
    }

    radiusInput.addEventListener('input', () => {
      const km = clamp(Number(radiusInput.value), 0.2, 50, 0.6);
      if (areaCircle) areaCircle.setRadius(km * 1000);
    });
    uncertaintyInput.addEventListener('input', () => {
      if (centerMarker) drawUncertainty(centerMarker.getLatLng(), clamp(Number(uncertaintyInput.value), 10, 200, 50));
    });

    // Try geolocation for centering
    if ((location.protocol === 'https:' || ['localhost','127.0.0.1','::1'].includes(location.hostname)) && 'geolocation' in navigator){
      navigator.geolocation.getCurrentPosition(
        pos => initMap(pos.coords.latitude, pos.coords.longitude),
        ()  => initMap(),
        { enableHighAccuracy:true, maximumAge:60000, timeout:12000 }
      );
    }else{
      initMap();
    }

    function clamp(n, min, max, fallback){
      n = Number.isFinite(n) ? n : fallback;
      return Math.max(min, Math.min(max, n));
    }
  </script>

  <!-- DEMO UI + PRESETS + SHARE (module; includes Firebase) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAHJuv3vZH1dMzLkihl6hNQdlHOQNg728M",
      authDomain: "seekr-426ff.firebaseapp.com",
      projectId: "seekr-426ff",
      storageBucket: "seekr-426ff.firebasestorage.app",
      messagingSenderId: "703306109182",
      appId: "1:703306109182:web:afb04af22e974170e555af"
    };

    // UI refs
    const codeEl       = document.getElementById('code');
    const btnCode      = document.getElementById('btnCode');
    const btnGoLobby   = document.getElementById('btnGoLobby');
    const btnCopyLobby = document.getElementById('btnCopyLobby');
    const btnShareWA   = document.getElementById('btnShareWA');
    const statusEl     = document.getElementById('status');

    // Rule inputs
    const radiusKm     = document.getElementById('radiusKm');
    const uncertaintyM = document.getElementById('uncertaintyM');
    const gameLen      = document.getElementById('gameLen');
    const tagDist      = document.getElementById('tagDist');
    const pingMins     = document.getElementById('pingMins');
    const revealRemain = document.getElementById('revealRemain');
    const puDelay      = document.getElementById('puDelay');
    const puDecoy      = document.getElementById('puDecoy');
    const puReveal     = document.getElementById('puReveal');

    // Presets
    document.getElementById('presetHunt').addEventListener('click', () => {
      gameLen.value = 25; tagDist.value = 8; pingMins.value = 3;
      radiusKm.value = 0.8; uncertaintyM.value = 50;
      puDelay.checked = true; puDecoy.checked = true; puReveal.checked = true;
      autoSetRevealIfNotDirty();
      radiusKm.dispatchEvent(new Event('input')); uncertaintyM.dispatchEvent(new Event('input'));
      nudge('Fugitive Hunt preset applied');
    });
    document.getElementById('presetTeam').addEventListener('click', () => {
      gameLen.value = 40; tagDist.value = 10; pingMins.value = 4;
      radiusKm.value = 1.2; uncertaintyM.value = 60;
      puDelay.checked = true; puDecoy.checked = false; puReveal.checked = true;
      autoSetRevealIfNotDirty();
      radiusKm.dispatchEvent(new Event('input')); uncertaintyM.dispatchEvent(new Event('input'));
      nudge('Team Battle preset applied');
    });
    document.getElementById('presetLarge').addEventListener('click', () => {
      gameLen.value = 60; tagDist.value = 12; pingMins.value = 5;
      radiusKm.value = 2.0; uncertaintyM.value = 75;
      puDelay.checked = true; puDecoy.checked = true; puReveal.checked = false;
      autoSetRevealIfNotDirty();
      radiusKm.dispatchEvent(new Event('input')); uncertaintyM.dispatchEvent(new Event('input'));
      nudge('Large Zone preset applied');
    });

    function nudge(t){
      statusEl.textContent = t;
      statusEl.style.color = 'var(--good)';
    }

    // Reveal timing: default 50% of game length (rounded), until user edits
    let revealDirty = false;
    function autoSetRevealIfNotDirty(){
      if (revealDirty) return;
      const gl = clampNum(Number(gameLen.value), 5, 240, 30);
      const auto = Math.max(1, Math.min(gl - 1, Math.round(gl * 0.5)));
      revealRemain.value = auto;
      revealRemain.max = String(Math.max(1, gl - 1));
    }
    gameLen.addEventListener('input', () => {
      const gl = clampNum(Number(gameLen.value), 5, 240, 30);
      gameLen.value = gl;
      if (!revealDirty) autoSetRevealIfNotDirty(); else revealRemain.max = String(Math.max(1, gl - 1));
    });
    revealRemain.addEventListener('input', () => {
      const gl = clampNum(Number(gameLen.value), 5, 240, 30);
      const rr = clampNum(Number(revealRemain.value), 1, gl - 1, Math.round(gl * 0.5));
      revealRemain.value = rr;
      revealDirty = true;
    });
    autoSetRevealIfNotDirty();

    function clampNum(n, min, max, fallback){
      n = Number.isFinite(n) ? n : fallback;
      return Math.max(min, Math.min(max, n));
    }

    // Code helpers
    function makeCode(len=6){
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let out = '';
      for(let i=0;i<len;i++){ out += chars[Math.floor(Math.random()*chars.length)]; }
      return out;
    }
    function updateUrlParam(key, val){
      const url = new URL(window.location.href);
      url.searchParams.set(key, val);
      window.history.replaceState({}, '', url);
    }

    btnCode.addEventListener('click', () => {
      codeEl.textContent = makeCode();
      statusEl.textContent = 'New code created, share this with friends';
      statusEl.style.color = 'var(--good)';
      updateUrlParam('code', codeEl.textContent.trim());
    });

    // Init Firebase + anon auth
    let db = null, auth = null;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      signInAnonymously(auth).catch(console.warn);
      onAuthStateChanged(auth, u => { if(u) console.log("Signed in (anon):", u.uid); });
    } catch (e) {
      console.warn("Firebase init failed ‚Äî you can still configure locally.", e);
    }

    // Save config to Firestore as a lobby round, then go to lobby
    btnGoLobby.addEventListener('click', async () => {
      const code = (codeEl.textContent.trim() || makeCode());
      if (!codeEl.textContent.trim()) {
        codeEl.textContent = code;
        updateUrlParam('code', code);
      }

      // Map-ready guard (no popup)
      const centerMarker = window.seekrCenterMarker;
      const center = centerMarker?.getLatLng?.();
      if (!center) {
        statusEl.textContent = 'Waiting for map‚Ä¶';
        statusEl.style.color = 'var(--muted)';
        return;
      }

      // Build docs
      const zone = {
        center: { lat: center.lat, lng: center.lng },
        radius_km: Number(radiusKm.value)
      };
      const rules = {
        game_minutes: Number(gameLen.value),
        tag_meters:   Number(tagDist.value),
        ping_minutes: Number(pingMins.value),
        uncertainty_m:Number(uncertaintyM.value),
        reveal_minutes_remaining: Number(revealRemain.value),
        actions: { delay: puDelay.checked, decoy: puDecoy.checked, reveal: puReveal.checked }
      };
      const lobbyConfig = { uncertaintyM: rules.uncertainty_m };

      // Always auto-generate a secret extraction inside the zone
      function destinationPoint(latlng, distanceMeters, bearingRad){
        const R = 6371000;
        const phi1 = latlng.lat * Math.PI / 180;
        const lam1 = latlng.lng * Math.PI / 180;
        const d = distanceMeters / R, th = bearingRad;
        const sinPhi1 = Math.sin(phi1), cosPhi1 = Math.cos(phi1);
        const sinD = Math.sin(d), cosD = Math.cos(d);
        const sinTh = Math.sin(th), cosTh = Math.cos(th);
        const sinPhi2 = sinPhi1 * cosD + cosPhi1 * sinD * cosTh;
        const phi2 = Math.asin(sinPhi2);
        const y = sinTh * sinD * cosPhi1;
        const x = cosD - sinPhi1 * sinPhi2;
        const lam2 = lam1 + Math.atan2(y, x);
        return { lat: phi2 * 180/Math.PI, lng: lam2 * 180/Math.PI };
      }
      function randomPointInCircle(centerLL, radiusMeters){
        const u = Math.random(), v = Math.random();
        const r = radiusMeters * Math.sqrt(u);
        const th = 2 * Math.PI * v;
        return destinationPoint(centerLL, r, th);
      }
      const radiusM = Number(radiusKm.value) * 1000;
      const secret = randomPointInCircle({ lat: center.lat, lng: center.lng }, radiusM);

      // Persist
      if (db && auth?.currentUser) {
        try{
          const uid = auth.currentUser.uid;
          const gameRef = doc(db, 'games', code);

          const snap = await getDoc(gameRef);
          const base = {
            code,
            status: 'lobby',
            zone,
            rules,
            lobbyConfig,
            updatedAt: serverTimestamp(),
            // clear stale live state (so lobby never thinks it‚Äôs live)
            startsAt: deleteField(),
            endsAt:   deleteField(),
            revealAt: deleteField(),
            fugitiveUid: deleteField()
          };

          if (!snap.exists()) {
            await setDoc(gameRef, { ...base, createdAt: serverTimestamp(), hostUid: uid }, { merge:true });
          } else {
            const g = snap.data() || {};
            await setDoc(gameRef, { ...base, ...(g.hostUid ? {} : { hostUid: uid }) }, { merge:true });
          }

          // Save secret extraction in private subdoc
          await setDoc(doc(db, 'games', code, 'private', 'secret'), secret, { merge:true });

          statusEl.textContent = 'Saved. Opening lobby‚Ä¶';
          statusEl.style.color = 'var(--good)';
        } catch (err) {
          console.warn('Failed to save to Firestore:', err);
          statusEl.textContent = 'Could not save to Firestore ‚Äî opening lobby anyway (you can still test).';
          statusEl.style.color = 'var(--bad)';
        }
      } else {
        statusEl.textContent = 'Opening lobby (no backend save ‚Äî Firebase not initialized).';
        statusEl.style.color = 'var(--muted)';
      }

      // Go to the lobby room
      const lobbyUrl = `${location.origin}/lobby.html?code=${encodeURIComponent(code)}`;
      location.href = lobbyUrl;
    });

    // Copy lobby link
    btnCopyLobby.addEventListener('click', async () => {
      const code = (codeEl.textContent.trim() || makeCode());
      if (!codeEl.textContent.trim()) {
        codeEl.textContent = code;
        updateUrlParam('code', code);
      }
      const lobbyUrl = `${location.origin}/lobby.html?code=${encodeURIComponent(code)}`;
      try{
        await navigator.clipboard.writeText(lobbyUrl);
        toast('Lobby link copied');
      }catch{
        alert(lobbyUrl);
      }
    });

    // WhatsApp share ‚Äî ‚ÄúPlay now / enter a code‚Äù
    btnShareWA.addEventListener('click', () => {
      const code = (codeEl.textContent.trim() || makeCode());
      if (!codeEl.textContent.trim()) {
        codeEl.textContent = code;
        updateUrlParam('code', code);
      }
      const lobbyUrl = `${location.origin}/lobby.html?code=${encodeURIComponent(code)}`;
      const text = `Seekr.run ‚Äî Play now / enter a code\nCode: ${code}\n${lobbyUrl}`;
      const url  = 'https://wa.me/?text=' + encodeURIComponent(text);
      const w = window.open(url, '_blank', 'noopener,noreferrer');
      if (w) w.opener = null;
    });

    // Tiny toast helper for module
    function toast(t){
      const el = document.getElementById('toast');
      el.textContent = t;
      el.style.display = 'block';
      clearTimeout(el._t);
      el._t = setTimeout(() => el.style.display = 'none', 2200);
    }

    // Read URL params to prefill
    window.addEventListener('DOMContentLoaded', () => {
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const r = parseFloat(url.searchParams.get('r'));
      const u = parseFloat(url.searchParams.get('u'));
      const g = parseFloat(url.searchParams.get('g'));
      const p = parseFloat(url.searchParams.get('p'));
      const t = parseFloat(url.searchParams.get('t'));
      if(code){ codeEl.textContent = code; }
      if(Number.isFinite(r)){ radiusKm.value = clampNum(r, 0.2, 50, 0.6); radiusKm.dispatchEvent(new Event('input')); }
      if(Number.isFinite(u)){ uncertaintyM.value = clampNum(u, 10, 200, 50); uncertaintyM.dispatchEvent(new Event('input')); }
      if(Number.isFinite(g)){ gameLen.value = clampNum(g, 5, 240, 30); autoSetRevealIfNotDirty(); }
      if(Number.isFinite(p)){ pingMins.value = clampNum(p, 1, 15, 5); }
      if(Number.isFinite(t)){ tagDist.value = clampNum(t, 2, 50, 8); }
      autoSetRevealIfNotDirty(); // ensure bounds reflect current game length
    });
  </script>

  <!-- Onboarding overlay logic (non-module) -->
  <script>
    const overlay = document.getElementById('overlay');
    const obSkip  = document.getElementById('obSkip');
    const obGo    = document.getElementById('obGo');

    function maybeShowOverlay(){
      try{
        if(sessionStorage.getItem('seekr_demo_seen')) return;
      }catch(_){}
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
    }
    function hideOverlay(){
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
      try{ sessionStorage.setItem('seekr_demo_seen', '1'); }catch(_){}
    }
    obSkip.addEventListener('click', hideOverlay);
    obGo.addEventListener('click', hideOverlay);
    overlay.addEventListener('click', (e) => { if(e.target === overlay) hideOverlay(); });
    document.addEventListener('keydown', (e) => { if(e.key === 'Escape') hideOverlay(); });

    // show on first load
    maybeShowOverlay();
  </script>
</body>
</html>
