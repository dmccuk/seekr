<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seekr.run, Gameplay</title>
  <link rel="icon" type="image/x-icon" href="assets/seekr-favicon.ico" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --ink:#0e1220; --muted:#55627a; --bg:#f6f8fc; --card:#ffffff;
      --brand:#1e4cff; --accent:#35c18f; --line:#e7ecf3;
      --good:#1f7a48; --bad:#b00020; --focus:#1e4cff33;
    }
    *{ box-sizing:border-box }
    html, body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height:1.35;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .shell{ max-width:1100px; margin:0 auto; padding:20px 16px 28px }

    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px }
    .brand{ font-weight:900; font-size:28px; letter-spacing:.6px; color:var(--ink) }
    .tag{ display:inline-block; font-size:13px; font-weight:600; color:var(--muted); padding:6px 10px; border-radius:999px; background:linear-gradient(180deg,#fff,#f7f9ff); border:1px solid var(--line) }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:0 10px 30px rgba(20,32,70,.06); }
    #map{ width:100%; height:min(68vh,560px); border-radius:12px; overflow:hidden }

    .hud{
      display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px; flex-wrap:wrap;
    }
    .btn{ appearance:none; border:0; border-radius:12px; padding:12px 14px; font-weight:800; color:#fff; background:linear-gradient(135deg,#4facfe,#00f2fe); cursor:pointer; box-shadow:0 4px 12px rgba(79,172,254,.35); }
    .btn.secondary{ background:linear-gradient(135deg,#00f2fe,#4facfe); }
    .pill{ display:inline-block; background:#eef2fa; border:1px solid var(--line); border-radius:999px; padding:8px 12px; font-size:13px; color:#55627a; }
    .notice{ margin-top:8px; font-size:12px; color:var(--muted) }

    /* Join overlay */
    .overlay{ position:fixed; inset:0; background:rgba(14,18,32,.6); display:none; align-items:center; justify-content:center; padding:16px; z-index:9999; }
    .overlay .sheet{ background:#fff; border:1px solid var(--line); border-radius:16px; padding:18px; max-width:420px; width:min(92vw,420px); box-shadow:0 20px 50px rgba(0,0,0,.25); }
    .overlay h3{ margin:0 0 8px 0; font-size:18px; font-weight:800 }
    .overlay p{ margin:0 0 10px 0; color:var(--muted) }
    .overlay .actions{ display:flex; gap:10px; justify-content:center; margin-top:12px }
    .overlay .actions .btn{ min-width:120px }

    .toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:#0e1220; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.2); display:none; z-index:99999; font-size:14px; }
    :focus-visible{ outline:3px solid var(--focus); outline-offset:2px; border-radius:8px }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <div class="brand">Seekr.run</div>
        <div class="tag" id="gameTag">Loading game…</div>
      </div>
      <a href="demo.html" class="btn secondary">Back</a>
    </header>

    <section class="card">
      <div id="map" aria-label="Live game map"></div>
      <div class="hud">
        <span id="timePill" class="pill">Time, 00:00</span>
        <button id="btnActions" class="btn secondary" type="button">Actions</button>
        <button id="btnPing" class="btn" type="button">Send ping</button>
      </div>
      <div id="hint" class="notice"></div>
    </section>
  </div>

  <!-- Join overlay -->
  <div id="join" class="overlay" role="dialog" aria-modal="true" aria-labelledby="joinTitle" aria-hidden="true">
    <div class="sheet">
      <h3 id="joinTitle">Join this round</h3>
      <p>Pick a side for code <strong id="joinCode">XXXXXX</strong>. You can open this on multiple phones.</p>
      <div class="actions">
        <button id="btnJoinF" class="btn" type="button">Fugitive</button>
        <button id="btnJoinS" class="btn secondary" type="button">Seeker</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // Firebase (CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot,
      addDoc, collection, query, where, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // --- YOUR FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAHJuv3vZH1dMzLkihl6hNQdlHOQNg728M",
      authDomain: "seekr-426ff.firebaseapp.com",
      projectId: "seekr-426ff",
      storageBucket: "seekr-426ff.firebasestorage.app",
      messagingSenderId: "703306109182",
      appId: "1:703306109182:web:afb04af22e974170e555af",
      // measurementId not needed here
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI elements
    const gameTag = document.getElementById('gameTag');
    const timePill = document.getElementById('timePill');
    const hint = document.getElementById('hint');
    const toastEl = document.getElementById('toast');
    const join = document.getElementById('join');
    const joinCodeEl = document.getElementById('joinCode');
    const btnPing = document.getElementById('btnPing');
    const btnActions = document.getElementById('btnActions');

    // Map
    let map, myMarker, extractMarker;
    let uncertaintyM = 50;   // default, updated from lobbyConfig
    let role = null;         // "fugitive" or "seeker"
    let code = new URL(location.href).searchParams.get("code")?.toUpperCase() || "";
    joinCodeEl.textContent = code || "XXXXXX";

    // Basic map init
    function initMap(lat=51.505, lng=-0.09){
      map = L.map('map', { zoomControl:true, attributionControl:false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
      map.setView([lat, lng], 15);
    }
    if (location.protocol === 'https:' && 'geolocation' in navigator){
      navigator.geolocation.getCurrentPosition(p => initMap(p.coords.latitude, p.coords.longitude), () => initMap());
    } else { initMap(); }

    function toast(t){
      toastEl.textContent = t;
      toastEl.style.display = 'block';
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(() => toastEl.style.display = 'none', 2200);
    }

    // Anonymous sign in, then attach listeners
    onAuthStateChanged(auth, async user => {
      if (!user) return;
      if (!code) { toast("Missing code in URL"); return; }
    
      const urlParams = new URL(location.href).searchParams;
      const roleHint = urlParams.get('as'); // "fugitive" or "seeker"
    
      const memberRef = doc(db, "games", code, "members", user.uid);
      const memberSnap = await getDoc(memberRef);
      role = memberSnap.exists() ? (memberSnap.data().role || null) : null;
    
      // If no role stored yet and we have a valid hint, auto-join and skip overlay
      if (!role && (roleHint === "fugitive" || roleHint === "seeker")) {
        role = roleHint;
        await setDoc(memberRef, { role, tokens: 500 }, { merge: true });
        toast(`Joined as ${role}`);
        afterJoin();
        return;
      }
    
      // Otherwise show the picker overlay
      if (!role) {
        join.style.display = 'flex';
        join.setAttribute('aria-hidden', 'false');
        document.getElementById('btnJoinF').onclick = async () => {
          role = "fugitive"; await setDoc(memberRef, { role, tokens: 500 }, { merge: true }); afterJoin();
        };
        document.getElementById('btnJoinS').onclick = async () => {
          role = "seeker"; await setDoc(memberRef, { role, tokens: 500 }, { merge: true }); afterJoin();
        };
        return;
      }
    
      // Already had a role
      afterJoin();
    });
    
    signInAnonymously(auth).catch(console.error);

    let revealToastShown = false;
    let timerId = null;

    async function afterJoin(){
      join.style.display = 'none';
      join.setAttribute('aria-hidden', 'true');
      gameTag.textContent = "Game " + code + " • You are " + role;

      const gameRef = doc(db, "games", code);

      // subscribe to game doc (times + config)
      onSnapshot(gameRef, snap => {
        if (!snap.exists()) { hint.textContent = "Game not found"; return; }
        const g = snap.data();

        // lobbyConfig: { uncertaintyM, ... }
        const cfg = g.lobbyConfig || {};
        uncertaintyM = Number(cfg.uncertaintyM || 50);

        // times
        const endsAt = g.endsAt?.toDate ? g.endsAt.toDate() : new Date(g.endsAt);
        const revealAt = g.revealAt?.toDate ? g.revealAt.toDate() : new Date(g.revealAt);
        const now = Date.now();

        // start/update local timer
        if (timerId) clearInterval(timerId);
        timerId = setInterval(() => {
          const left = Math.max(0, endsAt.getTime() - Date.now());
          const m = Math.floor(left/60000), s = String(Math.floor((left%60000)/1000)).padStart(2,'0');
          timePill.textContent = "Time, " + m + ":" + s;

          // Fugitive: show extraction when reveal hits
          if (role === "fugitive" && Date.now() >= revealAt.getTime()) {
            showExtraction().catch(()=>{});
          }

          if (left === 0) { clearInterval(timerId); timerId = null; }
        }, 1000);

        // If we loaded *after* reveal time, show immediately for fugitive
        if (role === "fugitive" && now >= revealAt.getTime()) {
          showExtraction().catch(()=>{});
        }

        // Seekers: notify at reveal time (but do not show the location)
        if (role === "seeker" && now >= revealAt.getTime() && !revealToastShown) {
          toast("Extraction location has been disclosed to fugitives.");
          revealToastShown = true;
        }

        // Hints
        if (role === "seeker") {
          hint.textContent = "You will see fugitive pings as blurred circles. You will be told when extraction is revealed.";
        } else {
          hint.textContent = "You never see seeker locations. Get to extraction when it appears.";
        }
      });

      // seekers track only fugitive pings
      if (role === "seeker") {
        const q = query(collection(db, "games", code, "pings"),
                        where("role", "==", "fugitive"),
                        orderBy("createdAt", "desc"),
                        limit(40));
        onSnapshot(q, snap => {
          // clear old layers first
          if (map._pingLayer) { map.removeLayer(map._pingLayer); }
          map._pingLayer = L.layerGroup().addTo(map);

          snap.forEach(docSnap => {
            const p = docSnap.data();
            const latlng = [p.lat, p.lng];
            // uncertainty circle for fugitive ping (uses lobbyConfig.uncertaintyM)
            L.circle(latlng, {
              radius: Number(uncertaintyM || 50),
              color: '#f59f00', weight: 2, fillColor: '#f59f00', fillOpacity: 0.12, dashArray: '4,6'
            }).addTo(map._pingLayer);
          });
        });
      }

      // fugitive can send pings
      btnPing.disabled = role !== "fugitive";
    }

    // Actions button (placeholder)
    btnActions.addEventListener('click', () => {
      toast("Actions coming soon: Decoy Ping, Delay Reveal.");
    });

    // Send ping (fugitive only), writes current GPS
    btnPing.addEventListener('click', () => {
      if (role !== "fugitive") { toast("Only fugitives send pings"); return; }
      if (!('geolocation' in navigator)) { toast("Location not available"); return; }
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude: lat, longitude: lng } = pos.coords;
        await addDoc(collection(db, "games", code, "pings"), {
          lat, lng, role, createdAt: serverTimestamp()
        });
        // show your position locally
        if (!myMarker) {
          myMarker = L.circleMarker([lat, lng], { radius:8, weight:3, color:'#1e4cff', fillColor:'#1e4cff', fillOpacity:.35 }).addTo(map);
        } else {
          myMarker.setLatLng([lat, lng]);
        }
        map.setView([lat, lng], 16);
        toast("Ping sent");
      }, () => toast("Could not get location"), { enableHighAccuracy: true, timeout: 12000 });
    });

    // Fetch and display extraction for fugitives, only after reveal time
    async function showExtraction(){
      if (extractMarker) return; // already shown
      const secretRef = doc(db, "games", code, "private", "secret");
      try{
        const snap = await getDoc(secretRef);
        if (!snap.exists()) return; // not created yet
        const { lat, lng } = snap.data();
        extractMarker = L.marker([lat, lng], {
          icon: L.divIcon({ className:'', html:'<div style="background:#1aa84b;color:#fff;border-radius:6px;padding:4px 6px;font-weight:800;box-shadow:0 2px 6px rgba(0,0,0,.25)">🏁 Extraction</div>' }),
          interactive:false
        }).addTo(map);
        toast("Extraction revealed — get within 10 meters to win.");
      }catch(e){
        // Likely blocked by security rules until reveal time; ignore.
      }
    }
  </script>
</body>
</html>
